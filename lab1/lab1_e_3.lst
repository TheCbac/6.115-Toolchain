     1              org 00h               ; Reset vector
     2  0000 020100   ljmp main          ; Jump to user entry point
     3                  
     4                  
     5              org 100h              ; main entry point at 100h
     6              main:       
     7  0100 12011D   lcall init          ; initialize the serial port
     8                loop:               ; infiinte loop
     9  0103 12012A     lcall getchr      ; get a character fomr the serial port
    10  0106 F590       mov P1, A
    11                  
    12  0108 787F       mov R0, #7Fh
    13  010A B50003     cjne A, 0, nobs
    14  010D 12013C     lcall backspace
    15                  nobs:
    16                  
    17  0110 780D       mov R0, #0Dh
    18  0112 B50003     cjne, A, 0, nocrlf
    19  0115 120161     lcall crlf
    20                  nocrlf:
    21                  
    22  0118 120134     lcall putchr      ; echo that character right back
    23  011B 80E6       sjmp loop           
    24                  
    25                  
    26              init:
    27                  ; assume 11.0592 Mhz Clock
    28                  ; user TIMER1 to create a 9600 baude connection
    29  011D 758920   mov tmod, #20h
    30  0120 758840   mov tcon, #40h
    31  0123 758DFD   mov th1,  #0FDh
    32  0126 759850   mov scon, #50h
    33  0129 22       ret
    34                  
    35              getchr:
    36                  ; This routine receives characters from the UART
    37                  ; jnb is bitwise jmp if bit not set
    38  012A 3098FD   jnb RI, getchr  ; wait until the rx interrupt flag is set
    39  012D E599     mov A, sbuf     ; move the character into the accumulator
    40  012F 547F     anl A, #7fh      ; clear 8th bit (since this should be ASCII)
    41  0131 C298     clr RI          ; clear the intterupt flag
    42  0133 22       ret
    43                  
    44                  
    45              putchr:
    46  0134 C299     clr scon.1          ; Clear the transmit done flag
    47  0136 F599     mov sbuf, a
    48                txloop:
    49  0138 3099FD     jnb TI, txloop    ; Wait until the character is actually sent
    50  013B 22         ret
    51                  
    52              backspace:
    53  013C C0E0     push acc
    54  013E 120156   lcall escape
    55  0141 7431     mov A, #31h ; '1'
    56  0143 120134   lcall putchr
    57  0146 7444     mov A, #44h ; 'D'
    58  0148 120134   lcall putchr
    59                  
    60  014B 120156   lcall escape
    61  014E 744B     mov A, #4Bh
    62  0150 120134   lcall putchr
    63  0153 D0E0     pop acc
    64  0155 22       ret
    65                    
    66                  
    67              escape:
    68  0156 741B     mov A, #1bh
    69  0158 120134   lcall putchr
    70  015B 745B     mov A, #5Bh ; [
    71  015D 120134   lcall putchr
    72  0160 22       ret
    73                  
    74                  
    75              crlf:
    76  0161 C0E0     push acc
    77  0163 740D     mov A, #0Dh
    78  0165 120134   lcall putchr
    79  0168 740A     mov A, #0Ah
    80  016A 120134   lcall putchr
    81  016D D0E0     pop acc
    82  016F 22       ret


