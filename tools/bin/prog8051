#!/usr/bin/python
import sys, ConfigParser, argparse, time, serial, threading

parser = argparse.ArgumentParser()
parser.add_argument("-p", "--serial-port", type=str,
                    default="/dev/tty.usbserial",
                    help="Set programming serial port")
parser.add_argument("name", type=str,
                    help="Object file to write to the 8051")

args = parser.parse_args()
port = serial.Serial(args.serial_port, baudrate=9600)

time.sleep(1)

def read():
    try:
        while True:
            sys.stdout.write(port.read())
    except:
        pass

read_thread = threading.Thread(target=read)
read_thread.daemon = True
read_thread.start()

def write(data):
    for char in data:
        port.write(char)
        port.flush()

program = open(args.name, 'r').read()
program = program.replace('\n', '')
program = program.replace('\r', '')

print "Sending code..."

write("D")
time.sleep(.5)
write(program)
time.sleep(.5)

port.close()
print
